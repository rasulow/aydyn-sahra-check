<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проверка заказов - Верификация данных</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'main/css/sargyt_check.css' %}">
</head>
<body>
    <div class="container">
        <a href="{% url 'main:home' %}" class="back-btn">← Вернуться на главную</a>
        
        <div class="header">
            <h1>Проверка заказов</h1>
            <p>Проверка и подтверждение данных заказов</p>
        </div>

        <div class="main-selection-container">
            <div class="selection-row">
                <div class="selection-group">
                    <label for="user-select">Выберите пользователя:</label>
                    <div class="searchable-select">
                        <input type="text" 
                               id="user-select" 
                               class="select-input" 
                               placeholder="Начните вводить имя пользователя..." 
                               autocomplete="off">
                        <div id="user-dropdown" class="dropdown-list"></div>
                    </div>
                </div>
                
                <div class="selection-group">
                    <label for="user-region">Регион пользователя:</label>
                    <input type="text" 
                           id="user-region" 
                           class="region-display" 
                           placeholder="Регион будет выбран автоматически" 
                           readonly>
                </div>
            </div>

            <div id="entries-container">
                <div class="order-entry" data-entry-number="1">
                    <div class="entry-header">
                        <h3 class="entry-title">Заказ #<span class="entry-number">1</span></h3>
                        <button class="remove-entry-btn" style="display: none;">✕</button>
                    </div>
                    
                    <div class="categories-section">
                        <div class="categories-title">Категории проверки</div>
                <div class="categories-grid">
                    <div class="category-block">
                        <div class="category-name">Zebra</div>
                    </div>

                    <div class="category-block">
                        <div class="category-name">Multi stor</div>
                    </div>

                    <div class="category-block">
                        <div class="category-name">Rol stor</div>
                    </div>

                    <div class="category-block">
                        <div class="category-name">Agac</div>
                    </div>

                    <div class="category-block">
                        <div class="category-name">Plise</div>
                    </div>

                    <div class="category-block">
                        <div class="category-name">Setka</div>
                    </div>

                    <div class="category-block">
                        <div class="category-name">Rim stor</div>
                    </div>

                    <div class="category-block">
                        <div class="category-name">Demir zalyuz</div>
                    </div>
                </div>
                
                <div class="karniz-section">
                    <div class="selection-group">
                        <label for="karniz-gornus">Karniz gornus:</label>
                        <select id="karniz-gornus" class="select-field">
                            <option value="">Выберите опцию...</option>
                            <option value="option1">Опция 1</option>
                            <option value="option2">Опция 2</option>
                            <option value="option3">Опция 3</option>
                            <option value="option4">Опция 4</option>
                        </select>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="selpe-checkbox" class="checkbox-input">
                        <label for="selpe-checkbox" class="checkbox-label">Selpe</label>
                    </div>
                    
                    <div class="selection-group selpe-select-group" id="selpe-select-group" style="display: none;">
                        <select id="selpe-select" class="select-field">
                            <option value="">Выберите...</option>
                            <option value="1-gat">1 gat</option>
                            <option value="2-gat">2 gat</option>
                            <option value="3-gat">3 gat</option>
                        </select>
                    </div>
                    
                    <div class="radio-group-vertical">
                        <div class="radio-item">
                            <input type="radio" id="turk-radio" name="region-radio" value="turk" class="radio-input">
                            <label for="turk-radio" class="radio-label">Turk</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="hytay-radio" name="region-radio" value="hytay" class="radio-input">
                            <label for="hytay-radio" class="radio-label">Hytay</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="yewropa-radio" name="region-radio" value="yewropa" class="radio-input">
                            <label for="yewropa-radio" class="radio-label">Yewropa</label>
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="weranda-checkbox" class="checkbox-input">
                        <label for="weranda-checkbox" class="checkbox-label">Weranda</label>
                    </div>
                    
                    <div class="selection-group weranda-select-group" id="weranda-select-group" style="display: none;">
                        <select id="weranda-select" class="select-field">
                            <option value="">Выберите...</option>
                            <option value="2-bolek">2 bolek</option>
                            <option value="3-bolek">3 bolek</option>
                            <option value="4-bolek">4 bolek</option>
                        </select>
                    </div>
                    
                    <div class="weranda-labels-container" id="weranda-labels-container" style="display: none;">
                        <div class="weranda-selection-title" id="weranda-selection-title"></div>
                        <div class="weranda-label" id="weranda-label-a" style="display: none;">
                            <span class="label-text">a</span>
                            <div class="label-inputs">
                                <div class="input-field-group">
                                    <label class="input-label">Width</label>
                                    <input type="number" class="label-input" placeholder="0" min="0" step="0.1">
                                </div>
                                <div class="input-field-group">
                                    <label class="input-label">Height</label>
                                    <input type="number" class="label-input" placeholder="0" min="0" step="0.1">
                                </div>
                            </div>
                        </div>
                        <div class="weranda-label" id="weranda-label-b" style="display: none;">
                            <span class="label-text">b</span>
                            <div class="label-inputs">
                                <div class="input-field-group">
                                    <label class="input-label">Width</label>
                                    <input type="number" class="label-input" placeholder="0" min="0" step="0.1">
                                </div>
                                <div class="input-field-group">
                                    <label class="input-label">Height</label>
                                    <input type="number" class="label-input" placeholder="0" min="0" step="0.1">
                                </div>
                            </div>
                        </div>
                        <div class="weranda-label" id="weranda-label-c" style="display: none;">
                            <span class="label-text">c</span>
                            <div class="label-inputs">
                                <div class="input-field-group">
                                    <label class="input-label">Width</label>
                                    <input type="number" class="label-input" placeholder="0" min="0" step="0.1">
                                </div>
                                <div class="input-field-group">
                                    <label class="input-label">Height</label>
                                    <input type="number" class="label-input" placeholder="0" min="0" step="0.1">
                                </div>
                            </div>
                        </div>
                        <div class="weranda-label" id="weranda-label-d" style="display: none;">
                            <span class="label-text">d</span>
                            <div class="label-inputs">
                                <div class="input-field-group">
                                    <label class="input-label">Width</label>
                                    <input type="number" class="label-input" placeholder="0" min="0" step="0.1">
                                </div>
                                <div class="input-field-group">
                                    <label class="input-label">Height</label>
                                    <input type="number" class="label-input" placeholder="0" min="0" step="0.1">
                                </div>
                            </div>
                        </div>
                        
                        <div class="kod-renk-section" id="kod-renk-section">
                            <label class="kod-renk-label">Kod renk:</label>
                            <div class="kod-renk-selects-container">
                                <div class="searchable-select kod-renk-select-wrapper">
                                    <input type="text" 
                                           id="kod-renk-select-1" 
                                           class="select-input" 
                                           placeholder="Начните вводить код цвета..." 
                                           autocomplete="off">
                                    <div id="kod-renk-dropdown-1" class="dropdown-list"></div>
                                </div>
                                <div class="searchable-select kod-renk-select-wrapper" id="kod-renk-select-2-wrapper" style="display: none;">
                                    <input type="text" 
                                           id="kod-renk-select-2" 
                                           class="select-input" 
                                           placeholder="Начните вводить код цвета 2..." 
                                           autocomplete="off">
                                    <div id="kod-renk-dropdown-2" class="dropdown-list"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="measurement-section">
                    <div class="measurement-container">
                        <div class="rectangle-wrapper">
                            <div class="top-measurement">
                                <input type="number" id="top-length" class="measurement-input horizontal" placeholder="Длина" min="0" step="0.1">
                            </div>
                            <div class="rectangle-with-left">
                                <div class="left-measurement">
                                    <input type="number" id="left-length" class="measurement-input vertical" placeholder="Высота" min="0" step="0.1">
                                </div>
                                <div class="rectangle"></div>
                            </div>
                        </div>
                        
                        <div class="kod-renk-section measurement-kod-renk" id="measurement-kod-renk-section">
                            <label class="kod-renk-label">Kod renk:</label>
                            <div class="kod-renk-selects-container">
                                <div class="searchable-select kod-renk-select-wrapper">
                                    <input type="text" 
                                           id="measurement-kod-renk-select-1" 
                                           class="select-input" 
                                           placeholder="Начните вводить код цвета..." 
                                           autocomplete="off">
                                    <div id="measurement-kod-renk-dropdown-1" class="dropdown-list"></div>
                                </div>
                                <div class="searchable-select kod-renk-select-wrapper" id="measurement-kod-renk-select-2-wrapper" style="display: none;">
                                    <input type="text" 
                                           id="measurement-kod-renk-select-2" 
                                           class="select-input" 
                                           placeholder="Начните вводить код цвета 2..." 
                                           autocomplete="off">
                                    <div id="measurement-kod-renk-dropdown-2" class="dropdown-list"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-buttons">
            <button class="action-btn add-btn" id="add-btn">
                <span class="btn-icon">+</span>
                <span class="btn-text">Добавить</span>
            </button>
            <button class="action-btn download-btn" id="download-btn">
                <span class="btn-icon">↓</span>
                <span class="btn-text">Скачать</span>
            </button>
        </div>
    </div>

    <script>
        // Load clients data from backend
        const users = {{ clients_json|safe }};

        const userInput = document.getElementById('user-select');
        const userDropdown = document.getElementById('user-dropdown');
        const regionDisplay = document.getElementById('user-region');
        const kodRenkInput1 = document.getElementById('kod-renk-select-1');
        const kodRenkDropdown1 = document.getElementById('kod-renk-dropdown-1');
        const kodRenkInput2 = document.getElementById('kod-renk-select-2');
        const kodRenkDropdown2 = document.getElementById('kod-renk-dropdown-2');
        const kodRenkSelect2Wrapper = document.getElementById('kod-renk-select-2-wrapper');
        
        const measurementKodRenkInput1 = document.getElementById('measurement-kod-renk-select-1');
        const measurementKodRenkDropdown1 = document.getElementById('measurement-kod-renk-dropdown-1');
        const measurementKodRenkInput2 = document.getElementById('measurement-kod-renk-select-2');
        const measurementKodRenkDropdown2 = document.getElementById('measurement-kod-renk-dropdown-2');
        const measurementKodRenkSelect2Wrapper = document.getElementById('measurement-kod-renk-select-2-wrapper');
        
        let selectedUser = null;
        let selectedKodRenk1 = null;
        let selectedKodRenk2 = null;
        let selectedMeasurementKodRenk1 = null;
        let selectedMeasurementKodRenk2 = null;

        // Filter and display users based on search
        function filterUsers(searchTerm) {
            const filtered = users.filter(user => 
                user.name.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            displayUsers(filtered);
        }

        // Display users in dropdown
        function displayUsers(userList) {
            userDropdown.innerHTML = '';
            
            if (userList.length === 0) {
                userDropdown.innerHTML = '<div class="dropdown-item">Пользователи не найдены</div>';
            } else {
                userList.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.textContent = user.name;
                    item.addEventListener('click', () => selectUser(user));
                    userDropdown.appendChild(item);
                });
            }
            
            userDropdown.style.display = 'block';
        }

        // Select user and set region
        function selectUser(user) {
            selectedUser = user;
            userInput.value = user.name;
            regionDisplay.value = user.region;
            regionDisplay.classList.add('filled');
            userDropdown.style.display = 'none';
            
            console.log('Выбран пользователь:', user.name, 'Регион:', user.region);
        }

        // Event listeners
        userInput.addEventListener('input', function() {
            const searchTerm = this.value.trim();
            
            if (searchTerm.length > 0) {
                filterUsers(searchTerm);
            } else {
                userDropdown.style.display = 'none';
                regionDisplay.value = '';
                regionDisplay.classList.remove('filled');
                selectedUser = null;
            }
        });

        userInput.addEventListener('focus', function() {
            if (this.value.trim().length > 0) {
                filterUsers(this.value.trim());
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const searchableSelect = event.target.closest('.searchable-select');
            if (!searchableSelect) {
                userDropdown.style.display = 'none';
                kodRenkDropdown1.style.display = 'none';
                kodRenkDropdown2.style.display = 'none';
                measurementKodRenkDropdown1.style.display = 'none';
                measurementKodRenkDropdown2.style.display = 'none';
            } else {
                // Close the dropdown that's not being interacted with
                if (!searchableSelect.contains(userInput)) {
                    userDropdown.style.display = 'none';
                }
                if (!searchableSelect.contains(kodRenkInput1)) {
                    kodRenkDropdown1.style.display = 'none';
                }
                if (!searchableSelect.contains(kodRenkInput2)) {
                    kodRenkDropdown2.style.display = 'none';
                }
                if (!searchableSelect.contains(measurementKodRenkInput1)) {
                    measurementKodRenkDropdown1.style.display = 'none';
                }
                if (!searchableSelect.contains(measurementKodRenkInput2)) {
                    measurementKodRenkDropdown2.style.display = 'none';
                }
            }
        });

        // Clear selection when input is manually cleared
        userInput.addEventListener('keydown', function(event) {
            if (event.key === 'Backspace' || event.key === 'Delete') {
                setTimeout(() => {
                    if (this.value.trim() === '') {
                        regionDisplay.value = '';
                        regionDisplay.classList.remove('filled');
                        selectedUser = null;
                    }
                }, 10);
            }
        });

        console.log('Страница проверки заказов загружена');
        console.log('Доступно пользователей:', users.length);

        // Load colors data from backend
        const kodRenks = {{ colors_json|safe }};

        // Helper function to setup kod renk select
        function setupKodRenkSelect(input, dropdown, selectCallback) {
            function filterKodRenks(searchTerm) {
                const filtered = kodRenks.filter(kr => 
                    kr.code.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                displayKodRenks(filtered);
            }

            function displayKodRenks(kodRenkList) {
                dropdown.innerHTML = '';
                
                if (kodRenkList.length === 0) {
                    dropdown.innerHTML = '<div class="dropdown-item">Коды не найдены</div>';
                } else {
                    kodRenkList.forEach(kr => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.textContent = kr.code + ' (Price: ' + kr.price + ')';
                        item.addEventListener('click', () => {
                            input.value = kr.code;
                            dropdown.style.display = 'none';
                            selectCallback(kr);
                            console.log('Выбран код цвета:', kr.code, 'Price:', kr.price);
                        });
                        dropdown.appendChild(item);
                    });
                }
                
                dropdown.style.display = 'block';
            }

            input.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                
                if (searchTerm.length > 0) {
                    filterKodRenks(searchTerm);
                } else {
                    dropdown.style.display = 'none';
                    selectCallback(null);
                }
            });

            input.addEventListener('focus', function() {
                if (this.value.trim().length > 0) {
                    filterKodRenks(this.value.trim());
                }
            });

            input.addEventListener('keydown', function(event) {
                if (event.key === 'Backspace' || event.key === 'Delete') {
                    setTimeout(() => {
                        if (this.value.trim() === '') {
                            selectCallback(null);
                        }
                    }, 10);
                }
            });
        }

        // Setup both kod renk selects for weranda section
        setupKodRenkSelect(kodRenkInput1, kodRenkDropdown1, (kr) => {
            selectedKodRenk1 = kr;
        });
        
        setupKodRenkSelect(kodRenkInput2, kodRenkDropdown2, (kr) => {
            selectedKodRenk2 = kr;
        });
        
        // Setup both kod renk selects for measurement section
        setupKodRenkSelect(measurementKodRenkInput1, measurementKodRenkDropdown1, (kr) => {
            selectedMeasurementKodRenk1 = kr;
        });
        
        setupKodRenkSelect(measurementKodRenkInput2, measurementKodRenkDropdown2, (kr) => {
            selectedMeasurementKodRenk2 = kr;
        });

        // Karniz gornus select functionality
        const karnizSelect = document.getElementById('karniz-gornus');
        let selectedKarnizOption = null;

        karnizSelect.addEventListener('change', function() {
            selectedKarnizOption = this.value;
            console.log('Выбрана опция Karniz gornus:', selectedKarnizOption);
        });

        // Selpe checkbox functionality
        const selpeCheckbox = document.getElementById('selpe-checkbox');
        const selpeSelectGroup = document.getElementById('selpe-select-group');
        const selpeSelect = document.getElementById('selpe-select');
        let selectedSelpeOption = null;

        selpeCheckbox.addEventListener('change', function() {
            if (this.checked) {
                selpeSelectGroup.style.display = 'block';
                console.log('Selpe checkbox включен');
            } else {
                selpeSelectGroup.style.display = 'none';
                selpeSelect.value = '';
                selectedSelpeOption = null;
                console.log('Selpe checkbox выключен');
            }
        });

        selpeSelect.addEventListener('change', function() {
            selectedSelpeOption = this.value;
            console.log('Выбрана опция Selpe:', selectedSelpeOption);
            // Update title if weranda is also selected
            if (werandaCheckbox.checked && selectedWerandaOption) {
                updateWerandaTitle();
            }
        });

        // Radio button functionality
        const radioButtons = document.querySelectorAll('input[name="region-radio"]');
        let selectedRegionRadio = null;

        radioButtons.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    selectedRegionRadio = this.value;
                    console.log('Выбран регион:', selectedRegionRadio);
                }
            });
        });

        // Weranda checkbox functionality
        const werandaCheckbox = document.getElementById('weranda-checkbox');
        const werandaSelectGroup = document.getElementById('weranda-select-group');
        const werandaSelect = document.getElementById('weranda-select');
        const werandaLabelsContainer = document.getElementById('weranda-labels-container');
        const werandaLabelA = document.getElementById('weranda-label-a');
        const werandaLabelB = document.getElementById('weranda-label-b');
        const werandaLabelC = document.getElementById('weranda-label-c');
        const werandaLabelD = document.getElementById('weranda-label-d');
        const measurementSection = document.querySelector('.measurement-section');
        let selectedWerandaOption = null;
        const werandaSelectionTitle = document.getElementById('weranda-selection-title');

        function updateWerandaTitle() {
            let titleText = '';
            
            // Add Selpe info if selected
            if (selpeCheckbox.checked && selectedSelpeOption) {
                titleText += 'Selpe: ' + selectedSelpeOption;
            }
            
            // Add Weranda info if selected
            if (selectedWerandaOption) {
                if (titleText) titleText += ' | ';
                titleText += 'Weranda: ' + selectedWerandaOption;
            }
            
            werandaSelectionTitle.textContent = titleText;
        }

        werandaCheckbox.addEventListener('change', function() {
            if (this.checked) {
                werandaSelectGroup.style.display = 'block';
                measurementSection.style.display = 'none';
                console.log('Weranda checkbox включен - measurement section скрыт');
            } else {
                werandaSelectGroup.style.display = 'none';
                werandaLabelsContainer.style.display = 'none';
                measurementSection.style.display = 'block';
                werandaSelect.value = '';
                selectedWerandaOption = null;
                // Hide all labels
                werandaLabelA.style.display = 'none';
                werandaLabelB.style.display = 'none';
                werandaLabelC.style.display = 'none';
                werandaLabelD.style.display = 'none';
                console.log('Weranda checkbox выключен - measurement section показан');
            }
        });

        werandaSelect.addEventListener('change', function() {
            selectedWerandaOption = this.value;
            console.log('Выбрана опция Weranda:', selectedWerandaOption);
            
            // Hide all labels first
            werandaLabelA.style.display = 'none';
            werandaLabelB.style.display = 'none';
            werandaLabelC.style.display = 'none';
            werandaLabelD.style.display = 'none';
            
            // Show labels based on selected option
            if (selectedWerandaOption === '2-bolek') {
                werandaLabelsContainer.style.display = 'flex';
                updateWerandaTitle();
                werandaLabelA.style.display = 'flex';
                werandaLabelB.style.display = 'flex';
                console.log('Показаны метки: a, b');
            } else if (selectedWerandaOption === '3-bolek') {
                werandaLabelsContainer.style.display = 'flex';
                updateWerandaTitle();
                werandaLabelA.style.display = 'flex';
                werandaLabelB.style.display = 'flex';
                werandaLabelC.style.display = 'flex';
                console.log('Показаны метки: a, b, c');
            } else if (selectedWerandaOption === '4-bolek') {
                werandaLabelsContainer.style.display = 'flex';
                updateWerandaTitle();
                werandaLabelA.style.display = 'flex';
                werandaLabelB.style.display = 'flex';
                werandaLabelC.style.display = 'flex';
                werandaLabelD.style.display = 'flex';
                console.log('Показаны метки: a, b, c, d');
            } else {
                werandaLabelsContainer.style.display = 'none';
                werandaSelectionTitle.textContent = '';
                console.log('Метки скрыты');
            }
        });

        // Measurement inputs functionality
        const topLengthInput = document.getElementById('top-length');
        const leftLengthInput = document.getElementById('left-length');
        let topLength = null;
        let leftLength = null;

        topLengthInput.addEventListener('input', function() {
            topLength = parseFloat(this.value) || null;
            console.log('Длина (верх):', topLength);
        });

        leftLengthInput.addEventListener('input', function() {
            leftLength = parseFloat(this.value) || null;
            console.log('Высота (лево):', leftLength);
        });

        // Category selection functionality (single select)
        const categoryBlocks = document.querySelectorAll('.category-block');
        let selectedCategory = null;

        categoryBlocks.forEach(block => {
            block.addEventListener('click', function() {
                const categoryName = this.querySelector('.category-name').textContent.trim();
                
                if (this.classList.contains('selected')) {
                    // Deselect current category
                    this.classList.remove('selected');
                    selectedCategory = null;
                } else {
                    // Deselect all other categories first
                    categoryBlocks.forEach(otherBlock => {
                        otherBlock.classList.remove('selected');
                    });
                    
                    // Select this category
                    this.classList.add('selected');
                    selectedCategory = categoryName;
                }
                
                // Show/hide second kod renk select based on Multi stor selection
                if (selectedCategory === 'Multi stor') {
                    kodRenkSelect2Wrapper.style.display = 'block';
                    measurementKodRenkSelect2Wrapper.style.display = 'block';
                    console.log('Показаны вторые kod renk selects');
                } else {
                    kodRenkSelect2Wrapper.style.display = 'none';
                    kodRenkInput2.value = '';
                    selectedKodRenk2 = null;
                    measurementKodRenkSelect2Wrapper.style.display = 'none';
                    measurementKodRenkInput2.value = '';
                    selectedMeasurementKodRenk2 = null;
                    console.log('Скрыты вторые kod renk selects');
                }
                
                console.log('Выбранная категория:', selectedCategory);
                updateCategoryDisplay();
            });
        });

        // Function to update category display or perform actions
        function updateCategoryDisplay() {
            if (selectedCategory) {
                console.log(`Выбрана категория: ${selectedCategory}`);
            } else {
                console.log('Ни одна категория не выбрана');
            }
            
            // You can add additional logic here, such as:
            // - Enabling/disabling buttons based on selection
            // - Updating form data
            // - Showing selected category in another part of the UI
        }

        // Optional: Add keyboard support (Space or Enter to toggle)
        categoryBlocks.forEach(block => {
            block.setAttribute('tabindex', '0');
            block.addEventListener('keydown', function(event) {
                if (event.key === ' ' || event.key === 'Enter') {
                    event.preventDefault();
                    this.click();
                }
            });
        });

        // Add new order entry functionality
        let entryCounter = 1;
        const addBtn = document.getElementById('add-btn');
        const entriesContainer = document.getElementById('entries-container');

        addBtn.addEventListener('click', function() {
            entryCounter++;
            
            // Clone the first entry
            const firstEntry = document.querySelector('.order-entry');
            const newEntry = firstEntry.cloneNode(true);
            
            // Update entry number
            newEntry.setAttribute('data-entry-number', entryCounter);
            newEntry.querySelector('.entry-number').textContent = entryCounter;
            
            // Show remove button
            const removeBtn = newEntry.querySelector('.remove-entry-btn');
            removeBtn.style.display = 'inline-block';
            
            // Clear all input values
            newEntry.querySelectorAll('input[type="number"]').forEach(input => {
                input.value = '';
            });
            
            // Reset checkboxes
            newEntry.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Reset radio buttons
            newEntry.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
                radio.name = 'region-radio-' + entryCounter; // Make radio groups unique per entry
            });
            
            // Reset select fields
            newEntry.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            
            // Hide conditional sections
            newEntry.querySelector('.selpe-select-group').style.display = 'none';
            newEntry.querySelector('.weranda-select-group').style.display = 'none';
            newEntry.querySelector('.weranda-labels-container').style.display = 'none';
            newEntry.querySelectorAll('.weranda-label').forEach(label => {
                label.style.display = 'none';
            });
            
            // Remove selected class from categories
            newEntry.querySelectorAll('.category-block').forEach(block => {
                block.classList.remove('selected');
            });
            
            // Update IDs to be unique
            updateEntryIds(newEntry, entryCounter);
            
            // Append to container
            entriesContainer.appendChild(newEntry);
            
            // Reinitialize event listeners for the new entry
            initializeEntryEventListeners(newEntry, entryCounter);
            
            // Show all remove buttons if there's more than one entry
            updateRemoveButtons();
            
            console.log('Добавлен новый заказ #' + entryCounter);
        });

        // Function to update IDs in cloned entry
        function updateEntryIds(entry, number) {
            const elementsWithId = entry.querySelectorAll('[id]');
            elementsWithId.forEach(element => {
                const oldId = element.id;
                element.id = oldId + '-' + number;
            });
            
            // Update for attributes in labels
            const labels = entry.querySelectorAll('label[for]');
            labels.forEach(label => {
                const oldFor = label.getAttribute('for');
                label.setAttribute('for', oldFor + '-' + number);
            });
        }

        // Function to initialize event listeners for a new entry
        function initializeEntryEventListeners(entry, entryNumber) {
            // Selpe checkbox
            const selpeCheckbox = entry.querySelector('[id^="selpe-checkbox"]');
            const selpeSelectGroup = entry.querySelector('.selpe-select-group');
            const selpeSelect = entry.querySelector('[id^="selpe-select"]');
            
            // Weranda checkbox
            const werandaCheckbox = entry.querySelector('[id^="weranda-checkbox"]');
            const werandaSelectGroup = entry.querySelector('.weranda-select-group');
            const werandaSelect = entry.querySelector('[id^="weranda-select"]');
            const werandaLabelsContainer = entry.querySelector('.weranda-labels-container');
            const measurementSection = entry.querySelector('.measurement-section');
            const werandaSelectionTitle = entry.querySelector('.weranda-selection-title');
            
            // Function to update title with both Selpe and Weranda selections
            function updateEntryTitle() {
                let titleText = '';
                
                if (selpeCheckbox.checked && selpeSelect.value) {
                    titleText += 'Selpe: ' + selpeSelect.value;
                }
                
                if (werandaSelect.value) {
                    if (titleText) titleText += ' | ';
                    titleText += 'Weranda: ' + werandaSelect.value;
                }
                
                werandaSelectionTitle.textContent = titleText;
            }
            
            selpeCheckbox.addEventListener('change', function() {
                selpeSelectGroup.style.display = this.checked ? 'block' : 'none';
                if (!this.checked) {
                    selpeSelect.value = '';
                }
                // Update title if weranda is selected
                if (werandaCheckbox.checked && werandaSelect.value) {
                    updateEntryTitle();
                }
            });
            
            selpeSelect.addEventListener('change', function() {
                // Update title if weranda is selected
                if (werandaCheckbox.checked && werandaSelect.value) {
                    updateEntryTitle();
                }
            });
            
            werandaCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    werandaSelectGroup.style.display = 'block';
                    measurementSection.style.display = 'none';
                } else {
                    werandaSelectGroup.style.display = 'none';
                    werandaLabelsContainer.style.display = 'none';
                    measurementSection.style.display = 'block';
                    werandaSelect.value = '';
                    entry.querySelectorAll('.weranda-label').forEach(label => {
                        label.style.display = 'none';
                    });
                }
            });
            
            // Weranda select
            werandaSelect.addEventListener('change', function() {
                const labels = {
                    'a': entry.querySelector('[id^="weranda-label-a"]'),
                    'b': entry.querySelector('[id^="weranda-label-b"]'),
                    'c': entry.querySelector('[id^="weranda-label-c"]'),
                    'd': entry.querySelector('[id^="weranda-label-d"]')
                };
                
                // Hide all labels first
                Object.values(labels).forEach(label => label.style.display = 'none');
                
                if (this.value === '2-bolek') {
                    werandaLabelsContainer.style.display = 'flex';
                    updateEntryTitle();
                    labels.a.style.display = 'flex';
                    labels.b.style.display = 'flex';
                } else if (this.value === '3-bolek') {
                    werandaLabelsContainer.style.display = 'flex';
                    updateEntryTitle();
                    labels.a.style.display = 'flex';
                    labels.b.style.display = 'flex';
                    labels.c.style.display = 'flex';
                } else if (this.value === '4-bolek') {
                    werandaLabelsContainer.style.display = 'flex';
                    updateEntryTitle();
                    labels.a.style.display = 'flex';
                    labels.b.style.display = 'flex';
                    labels.c.style.display = 'flex';
                    labels.d.style.display = 'flex';
                } else {
                    werandaLabelsContainer.style.display = 'none';
                    werandaSelectionTitle.textContent = '';
                }
            });
            
            // Category blocks
            const categoryBlocks = entry.querySelectorAll('.category-block');
            categoryBlocks.forEach(block => {
                block.addEventListener('click', function() {
                    if (this.classList.contains('selected')) {
                        this.classList.remove('selected');
                    } else {
                        entry.querySelectorAll('.category-block').forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');
                    }
                });
            });
            
            // Remove button
            const removeBtn = entry.querySelector('.remove-entry-btn');
            removeBtn.addEventListener('click', function() {
                entry.remove();
                updateRemoveButtons();
                console.log('Заказ удален');
            });
        }

        // Function to update visibility of remove buttons
        function updateRemoveButtons() {
            const entries = document.querySelectorAll('.order-entry');
            entries.forEach((entry, index) => {
                const removeBtn = entry.querySelector('.remove-entry-btn');
                if (entries.length > 1) {
                    removeBtn.style.display = 'inline-block';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }

        // Download button functionality
        const downloadBtn = document.getElementById('download-btn');
        downloadBtn.addEventListener('click', async function() {
            // Check if a user is selected
            if (!selectedUser) {
                alert('Пожалуйста, выберите пользователя перед скачиванием PDF');
                return;
            }

            // Collect all orders data
            const orders = [];
            const entries = document.querySelectorAll('.order-entry');
            
            entries.forEach((entry, index) => {
                const orderData = {};
                const entryNumber = entry.getAttribute('data-entry-number') || (index + 1);
                
                // Get selected category
                const selectedCategoryBlock = entry.querySelector('.category-block.selected');
                if (selectedCategoryBlock) {
                    orderData.category = selectedCategoryBlock.querySelector('.category-name').textContent.trim();
                }
                
                // Get karniz gornus
                const karnizSelect = entry.querySelector('[id^="karniz-gornus"]');
                if (karnizSelect && karnizSelect.value) {
                    orderData.karniz_gornus = karnizSelect.value;
                }
                
                // Get selpe
                const selpeCheckbox = entry.querySelector('[id^="selpe-checkbox"]');
                if (selpeCheckbox && selpeCheckbox.checked) {
                    const selpeSelect = entry.querySelector('[id^="selpe-select"]');
                    if (selpeSelect && selpeSelect.value) {
                        orderData.selpe = selpeSelect.value;
                    }
                }
                
                // Get region radio
                const selectedRadio = entry.querySelector('input[name^="region-radio"]:checked');
                if (selectedRadio) {
                    orderData.region_radio = selectedRadio.value;
                }
                
                // Get weranda data
                const werandaCheckbox = entry.querySelector('[id^="weranda-checkbox"]');
                if (werandaCheckbox && werandaCheckbox.checked) {
                    const werandaSelect = entry.querySelector('[id^="weranda-select"]');
                    if (werandaSelect && werandaSelect.value) {
                        orderData.weranda = werandaSelect.value;
                        
                        // Get weranda measurements
                        const werandaMeasurements = [];
                        const visibleLabels = entry.querySelectorAll('.weranda-label[style*="display: flex"]');
                        visibleLabels.forEach(label => {
                            const labelText = label.querySelector('.label-text').textContent;
                            const inputs = label.querySelectorAll('.label-input');
                            if (inputs.length >= 2) {
                                werandaMeasurements.push({
                                    label: labelText,
                                    width: inputs[0].value || '0',
                                    height: inputs[1].value || '0'
                                });
                            }
                        });
                        if (werandaMeasurements.length > 0) {
                            orderData.weranda_measurements = werandaMeasurements;
                        }
                    }
                } else {
                    // Get standard measurements if weranda is not selected
                    const topLength = entry.querySelector('[id^="top-length"]');
                    const leftLength = entry.querySelector('[id^="left-length"]');
                    
                    if ((topLength && topLength.value) || (leftLength && leftLength.value)) {
                        orderData.measurements = {
                            top_length: topLength ? topLength.value : '',
                            left_length: leftLength ? leftLength.value : ''
                        };
                    }
                }
                
                // Get kod renk (color codes)
                const kodRenkInputs = entry.querySelectorAll('[id*="kod-renk-select"]');
                const kodRenkValues = [];
                kodRenkInputs.forEach(input => {
                    // Skip dropdown elements
                    if (!input.id.includes('dropdown') && input.value && input.value.trim()) {
                        kodRenkValues.push(input.value.trim());
                    }
                });
                if (kodRenkValues.length > 0) {
                    orderData.kod_renk = kodRenkValues;
                }
                
                // Only add order if it has some data
                if (Object.keys(orderData).length > 0) {
                    orders.push(orderData);
                }
            });
            
            if (orders.length === 0) {
                alert('Нет данных для скачивания. Пожалуйста, заполните хотя бы один заказ.');
                return;
            }
            
            // Prepare the data to send
            const dataToSend = {
                client_name: selectedUser.name,
                client_region: selectedUser.region,
                orders: orders
            };
            
            console.log('Отправка данных на сервер:', dataToSend);
            
            try {
                // Send data to backend
                const response = await fetch('{% url "main:download_orders_pdf" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSend)
                });
                
                // Check if response is an error
                if (!response.ok) {
                    // Try to parse error message from JSON
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Ошибка при генерации PDF');
                    } else {
                        throw new Error('Ошибка при генерации PDF');
                    }
                }
                
                // Get the PDF blob
                const blob = await response.blob();
                
                // Check if blob is actually a PDF
                if (blob.type === 'application/json') {
                    // Server returned JSON error instead of PDF
                    const text = await blob.text();
                    const errorData = JSON.parse(text);
                    throw new Error(errorData.error || 'Неизвестная ошибка');
                }
                
                // Create a download link and trigger it
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `sargyt_orders_${new Date().getTime()}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                console.log('PDF успешно загружен');
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка: ' + error.message + '\n\nПроверьте консоль для деталей.');
            }
        });
    </script>
</body>
</html>
