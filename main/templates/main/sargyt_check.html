<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проверка заказов - Верификация данных</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'main/css/sargyt_check.css' %}">
</head>
<body>
    <div class="container">
        <a href="{% url 'main:home' %}" class="back-btn">← Вернуться на главную</a>
        
        <div class="header">
            <h1>Проверка заказов</h1>
            <p>Проверка и подтверждение данных заказов</p>
        </div>

        <div class="main-selection-container">
            <div class="selection-row">
                <div class="selection-group">
                    <label for="user-select">Выберите пользователя:</label>
                    <div class="searchable-select">
                        <input type="text" 
                               id="user-select" 
                               class="select-input" 
                               placeholder="Начните вводить имя пользователя..." 
                               autocomplete="off">
                        <div id="user-dropdown" class="dropdown-list"></div>
                    </div>
                </div>
                
                <div class="selection-group">
                    <label for="user-region">Регион пользователя:</label>
                    <input type="text" 
                           id="user-region" 
                           class="region-display" 
                           placeholder="Регион будет выбран автоматически" 
                           readonly>
                </div>
            </div>

            <div id="entries-container">
                <div class="order-entry" data-entry-number="1">
                    <div class="entry-header">
                        <h3 class="entry-title">Заказ #<span class="entry-number">1</span></h3>
                        <button class="remove-entry-btn" style="display: none;">✕</button>
                    </div>
                    
                    <div class="categories-section">
                        <div class="categories-title">Категории проверки</div>
                <div class="categories-grid">
                    <div class="category-block">
                        <div class="category-name">Zebra</div>
                    </div>

                    <div class="category-block">
                        <div class="category-name">Multi stor</div>
                    </div>

                    <div class="category-block">
                        <div class="category-name">Rol stor</div>
                    </div>

                    <div class="category-block">
                        <div class="category-name">Agac</div>
                    </div>

                    <div class="category-block">
                        <div class="category-name">Plise</div>
                    </div>

                    <div class="category-block">
                        <div class="category-name">Setka</div>
                    </div>

                    <div class="category-block">
                        <div class="category-name">Rim stor</div>
                    </div>

                    <div class="category-block">
                        <div class="category-name">Demir zalyuz</div>
                    </div>
                </div>
                
                <div class="karniz-section">
                    <div class="selection-group">
                        <label for="karniz-gornus">Karniz gornus:</label>
                        <select id="karniz-gornus" class="select-field">
                            <option value="">Выберите опцию...</option>
                            <option value="option1">Опция 1</option>
                            <option value="option2">Опция 2</option>
                            <option value="option3">Опция 3</option>
                            <option value="option4">Опция 4</option>
                        </select>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="selpe-checkbox" class="checkbox-input">
                        <label for="selpe-checkbox" class="checkbox-label">Selpe</label>
                    </div>
                    
                    <div class="selection-group selpe-select-group" id="selpe-select-group" style="display: none;">
                        <select id="selpe-select" class="select-field">
                            <option value="">Выберите...</option>
                            <option value="1-gat">1 gat</option>
                            <option value="2-gat">2 gat</option>
                            <option value="3-gat">3 gat</option>
                        </select>
                    </div>
                    
                    <div class="radio-group-vertical">
                        <div class="radio-item">
                            <input type="radio" id="turk-radio" name="region-radio" value="turk" class="radio-input">
                            <label for="turk-radio" class="radio-label">Turk</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="hytay-radio" name="region-radio" value="hytay" class="radio-input">
                            <label for="hytay-radio" class="radio-label">Hytay</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="yewropa-radio" name="region-radio" value="yewropa" class="radio-input">
                            <label for="yewropa-radio" class="radio-label">Yewropa</label>
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="weranda-checkbox" class="checkbox-input">
                        <label for="weranda-checkbox" class="checkbox-label">Weranda</label>
                    </div>
                    
                    <div class="selection-group weranda-select-group" id="weranda-select-group" style="display: none;">
                        <select id="weranda-select" class="select-field">
                            <option value="">Выберите...</option>
                            <option value="2-bolek">2 bolek</option>
                            <option value="3-bolek">3 bolek</option>
                            <option value="4-bolek">4 bolek</option>
                        </select>
                    </div>
                    
                    <div class="weranda-labels-container" id="weranda-labels-container" style="display: none;">
                        <div class="weranda-label" id="weranda-label-a" style="display: none;">
                            <span class="label-text">a</span>
                            <div class="label-inputs">
                                <div class="input-field-group">
                                    <label class="input-label">Width</label>
                                    <input type="number" class="label-input" placeholder="0" min="0" step="0.1">
                                </div>
                                <div class="input-field-group">
                                    <label class="input-label">Height</label>
                                    <input type="number" class="label-input" placeholder="0" min="0" step="0.1">
                                </div>
                            </div>
                        </div>
                        <div class="weranda-label" id="weranda-label-b" style="display: none;">
                            <span class="label-text">b</span>
                            <div class="label-inputs">
                                <div class="input-field-group">
                                    <label class="input-label">Width</label>
                                    <input type="number" class="label-input" placeholder="0" min="0" step="0.1">
                                </div>
                                <div class="input-field-group">
                                    <label class="input-label">Height</label>
                                    <input type="number" class="label-input" placeholder="0" min="0" step="0.1">
                                </div>
                            </div>
                        </div>
                        <div class="weranda-label" id="weranda-label-c" style="display: none;">
                            <span class="label-text">c</span>
                            <div class="label-inputs">
                                <div class="input-field-group">
                                    <label class="input-label">Width</label>
                                    <input type="number" class="label-input" placeholder="0" min="0" step="0.1">
                                </div>
                                <div class="input-field-group">
                                    <label class="input-label">Height</label>
                                    <input type="number" class="label-input" placeholder="0" min="0" step="0.1">
                                </div>
                            </div>
                        </div>
                        <div class="weranda-label" id="weranda-label-d" style="display: none;">
                            <span class="label-text">d</span>
                            <div class="label-inputs">
                                <div class="input-field-group">
                                    <label class="input-label">Width</label>
                                    <input type="number" class="label-input" placeholder="0" min="0" step="0.1">
                                </div>
                                <div class="input-field-group">
                                    <label class="input-label">Height</label>
                                    <input type="number" class="label-input" placeholder="0" min="0" step="0.1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="measurement-section">
                    <div class="measurement-container">
                        <div class="top-measurement">
                            <input type="number" id="top-length" class="measurement-input horizontal" placeholder="Длина" min="0" step="0.1">
                        </div>
                        <div class="rectangle-with-left">
                            <div class="left-measurement">
                                <input type="number" id="left-length" class="measurement-input vertical" placeholder="Высота" min="0" step="0.1">
                            </div>
                            <div class="rectangle"></div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-buttons">
            <button class="action-btn add-btn" id="add-btn">
                <span class="btn-icon">+</span>
                <span class="btn-text">Добавить</span>
            </button>
            <button class="action-btn download-btn" id="download-btn">
                <span class="btn-icon">↓</span>
                <span class="btn-text">Скачать</span>
            </button>
        </div>
    </div>

    <script>
        // Sample user data with regions
        const users = [
            { id: 1, name: 'Иванов Иван Иванович', region: 'Ашхабад' },
            { id: 2, name: 'Петров Петр Петрович', region: 'Ахал' },
            { id: 3, name: 'Сидоров Сидор Сидорович', region: 'Балкан' },
            { id: 4, name: 'Козлов Козел Козлович', region: 'Дашогуз' },
            { id: 5, name: 'Медведев Медведь Медведевич', region: 'Лебап' },
            { id: 6, name: 'Волков Волк Волкович', region: 'Мары' },
            { id: 7, name: 'Лисицын Лис Лисович', region: 'Ашхабад' },
            { id: 8, name: 'Зайцев Заяц Зайцевич', region: 'Ахал' },
            { id: 9, name: 'Орлов Орел Орлович', region: 'Балкан' },
            { id: 10, name: 'Соколов Сокол Соколович', region: 'Дашогуз' },
            { id: 11, name: 'Ястребов Ястреб Ястребович', region: 'Лебап' },
            { id: 12, name: 'Беркутов Беркут Беркутович', region: 'Мары' }
        ];

        const userInput = document.getElementById('user-select');
        const userDropdown = document.getElementById('user-dropdown');
        const regionDisplay = document.getElementById('user-region');
        let selectedUser = null;

        // Filter and display users based on search
        function filterUsers(searchTerm) {
            const filtered = users.filter(user => 
                user.name.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            displayUsers(filtered);
        }

        // Display users in dropdown
        function displayUsers(userList) {
            userDropdown.innerHTML = '';
            
            if (userList.length === 0) {
                userDropdown.innerHTML = '<div class="dropdown-item">Пользователи не найдены</div>';
            } else {
                userList.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.textContent = user.name;
                    item.addEventListener('click', () => selectUser(user));
                    userDropdown.appendChild(item);
                });
            }
            
            userDropdown.style.display = 'block';
        }

        // Select user and set region
        function selectUser(user) {
            selectedUser = user;
            userInput.value = user.name;
            regionDisplay.value = user.region;
            regionDisplay.classList.add('filled');
            userDropdown.style.display = 'none';
            
            console.log('Выбран пользователь:', user.name, 'Регион:', user.region);
        }

        // Event listeners
        userInput.addEventListener('input', function() {
            const searchTerm = this.value.trim();
            
            if (searchTerm.length > 0) {
                filterUsers(searchTerm);
            } else {
                userDropdown.style.display = 'none';
                regionDisplay.value = '';
                regionDisplay.classList.remove('filled');
                selectedUser = null;
            }
        });

        userInput.addEventListener('focus', function() {
            if (this.value.trim().length > 0) {
                filterUsers(this.value.trim());
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.searchable-select')) {
                userDropdown.style.display = 'none';
            }
        });

        // Clear selection when input is manually cleared
        userInput.addEventListener('keydown', function(event) {
            if (event.key === 'Backspace' || event.key === 'Delete') {
                setTimeout(() => {
                    if (this.value.trim() === '') {
                        regionDisplay.value = '';
                        regionDisplay.classList.remove('filled');
                        selectedUser = null;
                    }
                }, 10);
            }
        });

        console.log('Страница проверки заказов загружена');
        console.log('Доступно пользователей:', users.length);

        // Karniz gornus select functionality
        const karnizSelect = document.getElementById('karniz-gornus');
        let selectedKarnizOption = null;

        karnizSelect.addEventListener('change', function() {
            selectedKarnizOption = this.value;
            console.log('Выбрана опция Karniz gornus:', selectedKarnizOption);
        });

        // Selpe checkbox functionality
        const selpeCheckbox = document.getElementById('selpe-checkbox');
        const selpeSelectGroup = document.getElementById('selpe-select-group');
        const selpeSelect = document.getElementById('selpe-select');
        let selectedSelpeOption = null;

        selpeCheckbox.addEventListener('change', function() {
            if (this.checked) {
                selpeSelectGroup.style.display = 'block';
                console.log('Selpe checkbox включен');
            } else {
                selpeSelectGroup.style.display = 'none';
                selpeSelect.value = '';
                selectedSelpeOption = null;
                console.log('Selpe checkbox выключен');
            }
        });

        selpeSelect.addEventListener('change', function() {
            selectedSelpeOption = this.value;
            console.log('Выбрана опция Selpe:', selectedSelpeOption);
        });

        // Radio button functionality
        const radioButtons = document.querySelectorAll('input[name="region-radio"]');
        let selectedRegionRadio = null;

        radioButtons.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    selectedRegionRadio = this.value;
                    console.log('Выбран регион:', selectedRegionRadio);
                }
            });
        });

        // Weranda checkbox functionality
        const werandaCheckbox = document.getElementById('weranda-checkbox');
        const werandaSelectGroup = document.getElementById('weranda-select-group');
        const werandaSelect = document.getElementById('weranda-select');
        const werandaLabelsContainer = document.getElementById('weranda-labels-container');
        const werandaLabelA = document.getElementById('weranda-label-a');
        const werandaLabelB = document.getElementById('weranda-label-b');
        const werandaLabelC = document.getElementById('weranda-label-c');
        const werandaLabelD = document.getElementById('weranda-label-d');
        const measurementSection = document.querySelector('.measurement-section');
        let selectedWerandaOption = null;

        werandaCheckbox.addEventListener('change', function() {
            if (this.checked) {
                werandaSelectGroup.style.display = 'block';
                measurementSection.style.display = 'none';
                console.log('Weranda checkbox включен - measurement section скрыт');
            } else {
                werandaSelectGroup.style.display = 'none';
                werandaLabelsContainer.style.display = 'none';
                measurementSection.style.display = 'block';
                werandaSelect.value = '';
                selectedWerandaOption = null;
                // Hide all labels
                werandaLabelA.style.display = 'none';
                werandaLabelB.style.display = 'none';
                werandaLabelC.style.display = 'none';
                werandaLabelD.style.display = 'none';
                console.log('Weranda checkbox выключен - measurement section показан');
            }
        });

        werandaSelect.addEventListener('change', function() {
            selectedWerandaOption = this.value;
            console.log('Выбрана опция Weranda:', selectedWerandaOption);
            
            // Hide all labels first
            werandaLabelA.style.display = 'none';
            werandaLabelB.style.display = 'none';
            werandaLabelC.style.display = 'none';
            werandaLabelD.style.display = 'none';
            
            // Show labels based on selected option
            if (selectedWerandaOption === '2-bolek') {
                werandaLabelsContainer.style.display = 'flex';
                werandaLabelA.style.display = 'flex';
                werandaLabelB.style.display = 'flex';
                console.log('Показаны метки: a, b');
            } else if (selectedWerandaOption === '3-bolek') {
                werandaLabelsContainer.style.display = 'flex';
                werandaLabelA.style.display = 'flex';
                werandaLabelB.style.display = 'flex';
                werandaLabelC.style.display = 'flex';
                console.log('Показаны метки: a, b, c');
            } else if (selectedWerandaOption === '4-bolek') {
                werandaLabelsContainer.style.display = 'flex';
                werandaLabelA.style.display = 'flex';
                werandaLabelB.style.display = 'flex';
                werandaLabelC.style.display = 'flex';
                werandaLabelD.style.display = 'flex';
                console.log('Показаны метки: a, b, c, d');
            } else {
                werandaLabelsContainer.style.display = 'none';
                console.log('Метки скрыты');
            }
        });

        // Measurement inputs functionality
        const topLengthInput = document.getElementById('top-length');
        const leftLengthInput = document.getElementById('left-length');
        let topLength = null;
        let leftLength = null;

        topLengthInput.addEventListener('input', function() {
            topLength = parseFloat(this.value) || null;
            console.log('Длина (верх):', topLength);
        });

        leftLengthInput.addEventListener('input', function() {
            leftLength = parseFloat(this.value) || null;
            console.log('Высота (лево):', leftLength);
        });

        // Category selection functionality (single select)
        const categoryBlocks = document.querySelectorAll('.category-block');
        let selectedCategory = null;

        categoryBlocks.forEach(block => {
            block.addEventListener('click', function() {
                const categoryName = this.querySelector('.category-name').textContent.trim();
                
                if (this.classList.contains('selected')) {
                    // Deselect current category
                    this.classList.remove('selected');
                    selectedCategory = null;
                } else {
                    // Deselect all other categories first
                    categoryBlocks.forEach(otherBlock => {
                        otherBlock.classList.remove('selected');
                    });
                    
                    // Select this category
                    this.classList.add('selected');
                    selectedCategory = categoryName;
                }
                
                console.log('Выбранная категория:', selectedCategory);
                updateCategoryDisplay();
            });
        });

        // Function to update category display or perform actions
        function updateCategoryDisplay() {
            if (selectedCategory) {
                console.log(`Выбрана категория: ${selectedCategory}`);
            } else {
                console.log('Ни одна категория не выбрана');
            }
            
            // You can add additional logic here, such as:
            // - Enabling/disabling buttons based on selection
            // - Updating form data
            // - Showing selected category in another part of the UI
        }

        // Optional: Add keyboard support (Space or Enter to toggle)
        categoryBlocks.forEach(block => {
            block.setAttribute('tabindex', '0');
            block.addEventListener('keydown', function(event) {
                if (event.key === ' ' || event.key === 'Enter') {
                    event.preventDefault();
                    this.click();
                }
            });
        });

        // Add new order entry functionality
        let entryCounter = 1;
        const addBtn = document.getElementById('add-btn');
        const entriesContainer = document.getElementById('entries-container');

        addBtn.addEventListener('click', function() {
            entryCounter++;
            
            // Clone the first entry
            const firstEntry = document.querySelector('.order-entry');
            const newEntry = firstEntry.cloneNode(true);
            
            // Update entry number
            newEntry.setAttribute('data-entry-number', entryCounter);
            newEntry.querySelector('.entry-number').textContent = entryCounter;
            
            // Show remove button
            const removeBtn = newEntry.querySelector('.remove-entry-btn');
            removeBtn.style.display = 'inline-block';
            
            // Clear all input values
            newEntry.querySelectorAll('input[type="number"]').forEach(input => {
                input.value = '';
            });
            
            // Reset checkboxes
            newEntry.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Reset radio buttons
            newEntry.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
                radio.name = 'region-radio-' + entryCounter; // Make radio groups unique per entry
            });
            
            // Reset select fields
            newEntry.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            
            // Hide conditional sections
            newEntry.querySelector('.selpe-select-group').style.display = 'none';
            newEntry.querySelector('.weranda-select-group').style.display = 'none';
            newEntry.querySelector('.weranda-labels-container').style.display = 'none';
            newEntry.querySelectorAll('.weranda-label').forEach(label => {
                label.style.display = 'none';
            });
            
            // Remove selected class from categories
            newEntry.querySelectorAll('.category-block').forEach(block => {
                block.classList.remove('selected');
            });
            
            // Update IDs to be unique
            updateEntryIds(newEntry, entryCounter);
            
            // Append to container
            entriesContainer.appendChild(newEntry);
            
            // Reinitialize event listeners for the new entry
            initializeEntryEventListeners(newEntry, entryCounter);
            
            // Show all remove buttons if there's more than one entry
            updateRemoveButtons();
            
            console.log('Добавлен новый заказ #' + entryCounter);
        });

        // Function to update IDs in cloned entry
        function updateEntryIds(entry, number) {
            const elementsWithId = entry.querySelectorAll('[id]');
            elementsWithId.forEach(element => {
                const oldId = element.id;
                element.id = oldId + '-' + number;
            });
            
            // Update for attributes in labels
            const labels = entry.querySelectorAll('label[for]');
            labels.forEach(label => {
                const oldFor = label.getAttribute('for');
                label.setAttribute('for', oldFor + '-' + number);
            });
        }

        // Function to initialize event listeners for a new entry
        function initializeEntryEventListeners(entry, entryNumber) {
            // Selpe checkbox
            const selpeCheckbox = entry.querySelector('[id^="selpe-checkbox"]');
            const selpeSelectGroup = entry.querySelector('.selpe-select-group');
            const selpeSelect = entry.querySelector('[id^="selpe-select"]');
            
            selpeCheckbox.addEventListener('change', function() {
                selpeSelectGroup.style.display = this.checked ? 'block' : 'none';
                if (!this.checked) {
                    selpeSelect.value = '';
                }
            });
            
            // Weranda checkbox
            const werandaCheckbox = entry.querySelector('[id^="weranda-checkbox"]');
            const werandaSelectGroup = entry.querySelector('.weranda-select-group');
            const werandaSelect = entry.querySelector('[id^="weranda-select"]');
            const werandaLabelsContainer = entry.querySelector('.weranda-labels-container');
            const measurementSection = entry.querySelector('.measurement-section');
            
            werandaCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    werandaSelectGroup.style.display = 'block';
                    measurementSection.style.display = 'none';
                } else {
                    werandaSelectGroup.style.display = 'none';
                    werandaLabelsContainer.style.display = 'none';
                    measurementSection.style.display = 'block';
                    werandaSelect.value = '';
                    entry.querySelectorAll('.weranda-label').forEach(label => {
                        label.style.display = 'none';
                    });
                }
            });
            
            // Weranda select
            werandaSelect.addEventListener('change', function() {
                const labels = {
                    'a': entry.querySelector('[id^="weranda-label-a"]'),
                    'b': entry.querySelector('[id^="weranda-label-b"]'),
                    'c': entry.querySelector('[id^="weranda-label-c"]'),
                    'd': entry.querySelector('[id^="weranda-label-d"]')
                };
                
                // Hide all labels first
                Object.values(labels).forEach(label => label.style.display = 'none');
                
                if (this.value === '2-bolek') {
                    werandaLabelsContainer.style.display = 'flex';
                    labels.a.style.display = 'flex';
                    labels.b.style.display = 'flex';
                } else if (this.value === '3-bolek') {
                    werandaLabelsContainer.style.display = 'flex';
                    labels.a.style.display = 'flex';
                    labels.b.style.display = 'flex';
                    labels.c.style.display = 'flex';
                } else if (this.value === '4-bolek') {
                    werandaLabelsContainer.style.display = 'flex';
                    labels.a.style.display = 'flex';
                    labels.b.style.display = 'flex';
                    labels.c.style.display = 'flex';
                    labels.d.style.display = 'flex';
                } else {
                    werandaLabelsContainer.style.display = 'none';
                }
            });
            
            // Category blocks
            const categoryBlocks = entry.querySelectorAll('.category-block');
            categoryBlocks.forEach(block => {
                block.addEventListener('click', function() {
                    if (this.classList.contains('selected')) {
                        this.classList.remove('selected');
                    } else {
                        entry.querySelectorAll('.category-block').forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');
                    }
                });
            });
            
            // Remove button
            const removeBtn = entry.querySelector('.remove-entry-btn');
            removeBtn.addEventListener('click', function() {
                entry.remove();
                updateRemoveButtons();
                console.log('Заказ удален');
            });
        }

        // Function to update visibility of remove buttons
        function updateRemoveButtons() {
            const entries = document.querySelectorAll('.order-entry');
            entries.forEach((entry, index) => {
                const removeBtn = entry.querySelector('.remove-entry-btn');
                if (entries.length > 1) {
                    removeBtn.style.display = 'inline-block';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
