<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проверка заказов - Верификация данных</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'main/css/sargyt_check.css' %}">
</head>
<body>
    <div class="container">
        <a href="{% url 'main:home' %}" class="back-btn">← Вернуться на главную</a>
        
        <div class="header">
            <h1>Проверка заказов</h1>
            <p>Проверка и подтверждение данных заказов</p>
        </div>

        <div class="main-selection-container">
            <div class="selection-row">
                <div class="selection-group">
                    <label for="user-select">Выберите пользователя:</label>
                    <div class="searchable-select">
                        <input type="text" 
                               id="user-select" 
                               class="select-input" 
                               placeholder="Начните вводить имя пользователя..." 
                               autocomplete="off">
                        <div id="user-dropdown" class="dropdown-list"></div>
                    </div>
                </div>
                
                <div class="selection-group">
                    <label for="user-region">Регион пользователя:</label>
                    <input type="text" 
                           id="user-region" 
                           class="region-display" 
                           placeholder="Регион будет выбран автоматически" 
                           readonly>
                </div>
                
                <div class="selection-group">
                    <label for="currency-select">Valyuta:</label>
                    <select id="currency-select" class="select-field">
                        <option value="">Выберите валюту...</option>
                    </select>
                </div>
                
                <div class="selection-group">
                    <label for="client-type-select">Musderi gornusi:</label>
                    <select id="client-type-select" class="select-field">
                        <option value="">Выберите тип...</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="table-container" data-table-number="1">
            <div class="table-header">
                <h3 class="table-title">Заказ №1</h3>
                <button class="delete-table-btn" onclick="deleteTable(this)" title="Удалить таблицу">✕</button>
            </div>
            <table class="order-table" id="order-table">
                <thead>
                    <tr>
                        <th>№</th>
                        <th>Ini</th>
                        <th>Boyy</th>
                        <th>Karniz</th>
                        <th>Category</th>
                        <th>Kod renk</th>
                        <th>Selpe</th>
                        <th>Bellik</th>
                        <th>Sany</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <tr class="table-row" data-row-number="1">
                        <td class="row-number">1</td>
                        <td><input type="number" class="table-input" step="0.01" placeholder="0.00"></td>
                        <td><input type="number" class="table-input" step="0.01" placeholder="0.00"></td>
                        <td>
                            <select class="table-select karniz-select">
                                <option value="">Выберите...</option>
                                <option value="option1">Опция 1</option>
                                <option value="option2">Опция 2</option>
                                <option value="option3">Опция 3</option>
                                <option value="option4">Опция 4</option>
                            </select>
                        </td>
                        <td>
                            <select class="table-select category-select">
                                <option value="">Выберите...</option>
                            </select>
                        </td>
                        <td>
                            <div class="searchable-select-wrapper">
                                <input type="text" class="table-input kodrenk-search" placeholder="Начните вводить..." autocomplete="off">
                                <div class="kodrenk-dropdown"></div>
                            </div>
                        </td>
                        <td>
                            <select class="table-select selpe-select">
                                <option value="">-</option>
                                <option value="1-gat">1 gat</option>
                                <option value="2-gat">2 gat</option>
                                <option value="3-gat">3 gat</option>
                            </select>
                        </td>
                        <td><input type="text" class="table-input" placeholder="Примечание"></td>
                        <td><input type="number" class="table-input" value="1" min="1" step="1"></td>
                        <td>
                            <button class="remove-row-btn" onclick="removeRow(this)">✕</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <div class="table-buttons">
                <button class="add-row-btn" id="add-row-btn" onclick="addNewRow()">
                    <span class="btn-icon">+</span>
                    <span class="btn-text">Добавить строку</span>
                </button>
                <button class="add-table-btn" id="add-table-btn" onclick="addNewTable()">
                    <span class="btn-icon">+</span>
                    <span class="btn-text">Добавить заказ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Weranda selection -->
    <div id="weranda-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Добавить строку</h3>
            <p class="modal-question">Это Weranda?</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-yes" onclick="handleWerandaYes()">Да</button>
                <button class="modal-btn modal-btn-no" onclick="handleWerandaNo()">Нет</button>
            </div>
            <div id="weranda-options" class="weranda-options" style="display: none;">
                <label for="weranda-type-select">Выберите тип:</label>
                <select id="weranda-type-select" class="modal-select">
                    <option value="">Выберите...</option>
                    <option value="2-bolek">2 bolek</option>
                    <option value="3-bolek">3 bolek</option>
                    <option value="4-bolek">4 bolek</option>
                </select>
                <div class="modal-action-buttons">
                    <button class="modal-btn modal-btn-confirm" onclick="confirmWerandaRow()">Добавить</button>
                    <button class="modal-btn modal-btn-cancel" onclick="closeWerandaModal()">Отмена</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load clients data from backend
        const users = {{ clients_json|safe }};
        const currencies = {{ currencies_json|safe }};
        const clientTypes = {{ client_types_json|safe }};

        const userInput = document.getElementById('user-select');
        const userDropdown = document.getElementById('user-dropdown');
        const regionDisplay = document.getElementById('user-region');
        const currencySelect = document.getElementById('currency-select');
        const clientTypeSelect = document.getElementById('client-type-select');
        
        let selectedUser = null;
        let selectedCurrency = null;
        let selectedClientType = null;

        // Populate currency select
        currencies.forEach(currency => {
            const option = document.createElement('option');
            option.value = currency.id;
            option.textContent = currency.kod;
            currencySelect.appendChild(option);
        });

        // Populate client type select
        clientTypes.forEach(clientType => {
            const option = document.createElement('option');
            option.value = clientType.id;
            option.textContent = clientType.type;
            clientTypeSelect.appendChild(option);
        });

        // Currency select change handler
        currencySelect.addEventListener('change', function() {
            selectedCurrency = this.value ? currencies.find(c => c.id == this.value) : null;
            console.log('Выбрана валюта:', selectedCurrency);
        });

        // Client type select change handler
        clientTypeSelect.addEventListener('change', function() {
            selectedClientType = this.value ? clientTypes.find(ct => ct.id == this.value) : null;
            console.log('Выбран тип клиента:', selectedClientType);
        });

        // Filter and display users based on search
        function filterUsers(searchTerm) {
            const filtered = users.filter(user => 
                user.name.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            displayUsers(filtered);
        }

        // Display users in dropdown
        function displayUsers(userList) {
            userDropdown.innerHTML = '';
            
            if (userList.length === 0) {
                userDropdown.innerHTML = '<div class="dropdown-item">Пользователи не найдены</div>';
            } else {
                userList.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.textContent = user.name;
                    item.addEventListener('click', () => selectUser(user));
                    userDropdown.appendChild(item);
                });
            }
            
            userDropdown.style.display = 'block';
        }

        // Select user and set region
        function selectUser(user) {
            selectedUser = user;
            userInput.value = user.name;
            regionDisplay.value = user.region;
            regionDisplay.classList.add('filled');
            userDropdown.style.display = 'none';
            
            console.log('Выбран пользователь:', user.name, 'Регион:', user.region);
        }

        // Event listeners
        userInput.addEventListener('input', function() {
            const searchTerm = this.value.trim();
            
            if (searchTerm.length > 0) {
                filterUsers(searchTerm);
            } else {
                userDropdown.style.display = 'none';
                regionDisplay.value = '';
                regionDisplay.classList.remove('filled');
                selectedUser = null;
            }
        });

        userInput.addEventListener('focus', function() {
            if (this.value.trim().length > 0) {
                filterUsers(this.value.trim());
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const searchableSelect = event.target.closest('.searchable-select');
            if (!searchableSelect) {
                userDropdown.style.display = 'none';
            } else {
                // Close the dropdown that's not being interacted with
                if (!searchableSelect.contains(userInput)) {
                    userDropdown.style.display = 'none';
                }
            }
        });

        // Clear selection when input is manually cleared
        userInput.addEventListener('keydown', function(event) {
            if (event.key === 'Backspace' || event.key === 'Delete') {
                setTimeout(() => {
                    if (this.value.trim() === '') {
                        regionDisplay.value = '';
                        regionDisplay.classList.remove('filled');
                        selectedUser = null;
                    }
                }, 10);
            }
        });

        console.log('Страница проверки заказов загружена');
        console.log('Доступно пользователей:', users.length);

        // Load colors for table
        const kodRenks = {{ colors_json|safe }};
        
        // Load categories
        const categories = {{ categories_json|safe }};
        
        // Populate category dropdowns
        function populateCategorySelect(selectElement) {
            // Clear existing options except the first one
            selectElement.innerHTML = '<option value="">Выберите...</option>';
            
            // Add categories from database
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                selectElement.appendChild(option);
            });
        }
        
        // Populate all existing category dropdowns
        document.querySelectorAll('.category-select').forEach(select => {
            populateCategorySelect(select);
        });

        // Close modal when clicking outside
        document.getElementById('weranda-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeWerandaModal();
            }
        });

        // Function to setup kod renk searchable select for table rows
        function setupKodRenkSearch(input, dropdown) {
            input.addEventListener('input', function() {
                const searchTerm = this.value.trim().toLowerCase();
                
                if (searchTerm.length > 0) {
                    const filtered = kodRenks.filter(kr => 
                        kr.code.toLowerCase().includes(searchTerm)
                    );
                    displayKodRenkOptions(dropdown, filtered, input);
                } else {
                    dropdown.style.display = 'none';
                }
            });

            input.addEventListener('focus', function() {
                if (this.value.trim().length > 0) {
                    const searchTerm = this.value.trim().toLowerCase();
                    const filtered = kodRenks.filter(kr => 
                        kr.code.toLowerCase().includes(searchTerm)
                    );
                    displayKodRenkOptions(dropdown, filtered, input);
                }
            });
        }

        function displayKodRenkOptions(dropdown, kodRenkList, input) {
            dropdown.innerHTML = '';
            
            if (kodRenkList.length === 0) {
                dropdown.innerHTML = '<div class="kodrenk-item">Коды не найдены</div>';
            } else {
                kodRenkList.forEach(kr => {
                    const item = document.createElement('div');
                    item.className = 'kodrenk-item';
                    item.textContent = kr.code + ' (Price: ' + kr.price + ')';
                    item.addEventListener('click', () => {
                        input.value = kr.code;
                        dropdown.style.display = 'none';
                        console.log('Selected kod renk:', kr.code);
                    });
                    dropdown.appendChild(item);
                });
            }
            
            dropdown.style.display = 'block';
        }

        // Setup initial row
        document.querySelectorAll('.kodrenk-search').forEach((input) => {
            const dropdown = input.nextElementSibling;
            setupKodRenkSearch(input, dropdown);
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.searchable-select-wrapper')) {
                document.querySelectorAll('.kodrenk-dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });

        // Global variable to store weranda type
        let currentWerandaType = null;
        let isWerandaRow = false;
        let werandaGroupCounter = 0;

        // Function to add new row - opens modal
        function addNewRow() {
            const modal = document.getElementById('weranda-modal');
            modal.classList.add('show');
        }

        // Handle Yes button click
        function handleWerandaYes() {
            document.getElementById('weranda-options').style.display = 'block';
            document.querySelector('.modal-buttons').style.display = 'none';
            isWerandaRow = true;
        }

        // Handle No button click
        function handleWerandaNo() {
            isWerandaRow = false;
            currentWerandaType = null;
            closeWerandaModal();
            actuallyAddNewRow();
        }

        // Confirm Weranda row with type
        function confirmWerandaRow() {
            const werandaTypeSelect = document.getElementById('weranda-type-select');
            currentWerandaType = werandaTypeSelect.value;
            
            if (!currentWerandaType) {
                alert('Пожалуйста, выберите тип Weranda');
                return;
            }
            
            closeWerandaModal();
            actuallyAddNewRow();
        }

        // Close modal
        function closeWerandaModal() {
            const modal = document.getElementById('weranda-modal');
            modal.classList.remove('show');
            
            // Reset modal state
            document.getElementById('weranda-options').style.display = 'none';
            document.querySelector('.modal-buttons').style.display = 'flex';
            document.getElementById('weranda-type-select').selectedIndex = 0;
        }

        // Actually add the new row
        function actuallyAddNewRow() {
            // Find the table container that contains the clicked button
            const allTableContainers = document.querySelectorAll('.table-container');
            const lastTableContainer = allTableContainers[allTableContainers.length - 1];
            const tableBody = lastTableContainer.querySelector('[id^="table-body"]');
            
            // Get the highest row number used so far
            const currentRows = tableBody.querySelectorAll('.table-row');
            let maxRowNumber = 0;
            
            currentRows.forEach(row => {
                const rowNum = parseInt(row.getAttribute('data-row-number'));
                if (rowNum > maxRowNumber) {
                    maxRowNumber = rowNum;
                }
            });
            
            const newRowNumber = maxRowNumber + 1;
            
            // Determine how many rows to add based on weranda type
            let rowCount = 1;
            let rowLabels = [''];
            
            if (isWerandaRow && currentWerandaType) {
                switch(currentWerandaType) {
                    case '2-bolek':
                        rowCount = 2;
                        rowLabels = ['a', 'b'];
                        break;
                    case '3-bolek':
                        rowCount = 3;
                        rowLabels = ['a', 'b', 'c'];
                        break;
                    case '4-bolek':
                        rowCount = 4;
                        rowLabels = ['a', 'b', 'c', 'd'];
                        break;
                }
            }
            
            // Increment weranda group counter if this is a weranda group
            let currentGroupId = null;
            if (isWerandaRow && currentWerandaType) {
                werandaGroupCounter++;
                currentGroupId = werandaGroupCounter;
            }
            
            // Add rows based on count
            for (let i = 0; i < rowCount; i++) {
                addSingleRow(tableBody, newRowNumber, rowLabels[i], currentGroupId);
            }
            
            if (isWerandaRow && currentWerandaType) {
                console.log(`Добавлено ${rowCount} строк (Weranda: ${currentWerandaType}) с метками: ${rowLabels.join(', ')}, группа ${currentGroupId}`);
            } else {
                console.log('Добавлена новая строка #' + newRowNumber);
            }
            
            // Reset weranda state
            isWerandaRow = false;
            currentWerandaType = null;
        }
        
        // Helper function to add a single row
        function addSingleRow(tableBody, rowNumber, label, groupId) {
            const newRow = document.createElement('tr');
            newRow.className = 'table-row';
            newRow.setAttribute('data-row-number', rowNumber);
            
            // Mark as weranda row if applicable
            if (isWerandaRow) {
                newRow.setAttribute('data-weranda', 'true');
                newRow.setAttribute('data-weranda-type', currentWerandaType);
                if (label) {
                    newRow.setAttribute('data-weranda-label', label);
                }
                if (groupId) {
                    newRow.setAttribute('data-weranda-group', groupId);
                }
            }
            
            // Display row number with label if it's a weranda sub-row
            const displayNumber = label ? `${rowNumber}${label}` : rowNumber;
            
            newRow.innerHTML = `
                <td class="row-number">${displayNumber}</td>
                <td><input type="number" class="table-input" step="0.01" placeholder="0.00"></td>
                <td><input type="number" class="table-input" step="0.01" placeholder="0.00"></td>
                <td>
                    <select class="table-select karniz-select">
                        <option value="">Выберите...</option>
                        <option value="option1">Опция 1</option>
                        <option value="option2">Опция 2</option>
                        <option value="option3">Опция 3</option>
                        <option value="option4">Опция 4</option>
                    </select>
                </td>
                <td>
                    <select class="table-select category-select">
                        <option value="">Выберите...</option>
                    </select>
                </td>
                <td>
                    <div class="searchable-select-wrapper">
                        <input type="text" class="table-input kodrenk-search" placeholder="Начните вводить..." autocomplete="off">
                        <div class="kodrenk-dropdown"></div>
                    </div>
                </td>
                <td>
                    <select class="table-select selpe-select">
                        <option value="">-</option>
                        <option value="1-gat">1 gat</option>
                        <option value="2-gat">2 gat</option>
                        <option value="3-gat">3 gat</option>
                    </select>
                </td>
                <td><input type="text" class="table-input" placeholder="Примечание"></td>
                <td><input type="number" class="table-input" value="1" min="1" step="1"></td>
                <td>
                    <button class="remove-row-btn" onclick="removeRow(this)">✕</button>
                </td>
            `;
            
            tableBody.appendChild(newRow);
            
            // Setup kod renk search for new row
            const newKodRenkInput = newRow.querySelector('.kodrenk-search');
            const newKodRenkDropdown = newRow.querySelector('.kodrenk-dropdown');
            setupKodRenkSearch(newKodRenkInput, newKodRenkDropdown);
            
            // Populate category dropdown for new row
            const newCategorySelect = newRow.querySelector('.category-select');
            populateCategorySelect(newCategorySelect);
            
            // If it's a weranda row, add visual indicator in Bellik field
            if (isWerandaRow && currentWerandaType) {
                const bellikInput = newRow.querySelector('td:nth-child(8) input');
                const labelText = label ? ` - ${label}` : '';
                bellikInput.value = `Weranda (${currentWerandaType}${labelText})`;
                bellikInput.style.fontWeight = '600';
                bellikInput.style.color = '#667eea';
            }
        }

        // Function to remove row
        function removeRow(button) {
            const row = button.closest('.table-row');
            const tableBody = row.closest('tbody');
            
            // Don't allow removing if only one row remains
            if (tableBody.children.length <= 1) {
                alert('Нельзя удалить последнюю строку!');
                return;
            }
            
            row.remove();
            
            // Renumber rows in this specific table
            const rows = tableBody.querySelectorAll('.table-row');
            let currentNumber = 1;
            let i = 0;
            
            while (i < rows.length) {
                const currentRow = rows[i];
                const isWeranda = currentRow.getAttribute('data-weranda') === 'true';
                const werandaLabel = currentRow.getAttribute('data-weranda-label');
                
                if (isWeranda && werandaLabel) {
                    // This is a weranda row, find all rows in this group
                    const werandaType = currentRow.getAttribute('data-weranda-type');
                    let groupSize = 1;
                    
                    // Count how many consecutive weranda rows with the same type
                    while (i + groupSize < rows.length) {
                        const nextRow = rows[i + groupSize];
                        if (nextRow.getAttribute('data-weranda') === 'true' && 
                            nextRow.getAttribute('data-weranda-type') === werandaType &&
                            nextRow.getAttribute('data-weranda-label')) {
                            groupSize++;
                        } else {
                            break;
                        }
                    }
                    
                    // Assign the same number to all rows in the group
                    for (let j = 0; j < groupSize; j++) {
                        const row = rows[i + j];
                        const label = row.getAttribute('data-weranda-label');
                        row.setAttribute('data-row-number', currentNumber);
                        row.querySelector('.row-number').textContent = currentNumber + label;
                    }
                    
                    i += groupSize;
                } else {
                    // Regular row
                    currentRow.setAttribute('data-row-number', currentNumber);
                    currentRow.querySelector('.row-number').textContent = currentNumber;
                    i++;
                }
                
                currentNumber++;
            }
            
            console.log('Строка удалена');
        }

        // Function to add new table
        function addNewTable() {
            const mainContainer = document.querySelector('.container');
            const allTableContainers = document.querySelectorAll('.table-container');
            const lastTableContainer = allTableContainers[allTableContainers.length - 1];
            
            // Get the next table number
            const lastTableNumber = parseInt(lastTableContainer.getAttribute('data-table-number'));
            const newTableNumber = lastTableNumber + 1;
            
            // Remove buttons from current table
            const currentButtons = lastTableContainer.querySelector('.table-buttons');
            currentButtons.remove();
            
            // Clone the last table container (without buttons now)
            const newTableContainer = lastTableContainer.cloneNode(true);
            
            // Update table number
            newTableContainer.setAttribute('data-table-number', newTableNumber);
            const tableTitle = newTableContainer.querySelector('.table-title');
            tableTitle.textContent = 'Заказ №' + newTableNumber;
            
            // Get all rows in the new table and keep only the first one
            const newTableBody = newTableContainer.querySelector('[id^="table-body"]');
            const rows = newTableBody.querySelectorAll('.table-row');
            
            // Remove all rows except the first one
            for (let i = 1; i < rows.length; i++) {
                rows[i].remove();
            }
            
            // Reset the first row's inputs
            const inputs = newTableBody.querySelectorAll('input');
            inputs.forEach(input => {
                if (input.type === 'number' && input.closest('td:nth-child(9)')) {
                    input.value = '1'; // Sany field default
                } else if (input.type === 'number') {
                    input.value = '';
                } else {
                    input.value = '';
                }
            });
            
            // Reset selects
            const selects = newTableBody.querySelectorAll('select');
            selects.forEach(select => {
                select.selectedIndex = 0;
            });
            
            // Reset row number
            newTableBody.querySelector('.row-number').textContent = '1';
            newTableBody.querySelector('.table-row').setAttribute('data-row-number', '1');
            
            // Update IDs to be unique
            const newTable = newTableContainer.querySelector('[id^="order-table"]');
            const timestamp = Date.now();
            newTable.id = 'order-table-' + timestamp;
            newTableBody.id = 'table-body-' + timestamp;
            
            // Setup kod renk search for the new table
            const kodRenkInputs = newTableContainer.querySelectorAll('.kodrenk-search');
            kodRenkInputs.forEach((input) => {
                const dropdown = input.nextElementSibling;
                setupKodRenkSearch(input, dropdown);
            });
            
            // Add buttons back to the new table
            newTableContainer.appendChild(currentButtons);
            
            // Insert the new table after the last table container
            lastTableContainer.parentNode.insertBefore(newTableContainer, lastTableContainer.nextSibling);
            
            console.log('Добавлена новая таблица: Заказ №' + newTableNumber);
        }

        // Function to delete table
        function deleteTable(button) {
            const allTableContainers = document.querySelectorAll('.table-container');
            
            // Don't allow deleting if only one table remains
            if (allTableContainers.length <= 1) {
                alert('Нельзя удалить последнюю таблицу!');
                return;
            }
            
            const tableContainer = button.closest('.table-container');
            const hasButtons = tableContainer.querySelector('.table-buttons') !== null;
            
            // If this table has the buttons, move them to the last remaining table
            if (hasButtons) {
                const buttons = tableContainer.querySelector('.table-buttons');
                buttons.remove();
                
                // Find a table to move buttons to (preferably the previous one, or the next one)
                let targetTable = tableContainer.previousElementSibling;
                if (!targetTable || !targetTable.classList.contains('table-container')) {
                    targetTable = tableContainer.nextElementSibling;
                }
                
                if (targetTable && targetTable.classList.contains('table-container')) {
                    targetTable.appendChild(buttons);
                }
            }
            
            // Remove the table
            const tableNumber = tableContainer.getAttribute('data-table-number');
            tableContainer.remove();
            
            console.log('Удалена таблица: Заказ №' + tableNumber);
        }
    </script>
</body>
</html>
